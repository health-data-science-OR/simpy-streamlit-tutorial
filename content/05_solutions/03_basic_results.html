

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Results collection exercise &#8212; Simulation in python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/05_solutions/03_basic_results';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Adding a patient callback from a nurse" href="04_callback.html" />
    <link rel="prev" title="Generator exercise" href="02_generator.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../front_page.html">
  
  
  
  
  
    <p class="title logo__title">Simulation in python</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../front_page.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_setup/install.html">Install python and an IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_setup/reading.html">Recommended Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_setup/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_setup/citation.html">Citation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Simulation with simpy</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../02_simpy/01_sampling.html">Random variables and simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_simpy/02_basic_simpy.html">A first look at simpy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_simpy/03_111_model.html">A full model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_simpy/04_basic_results.html">Collecting results from a single run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_simpy/05_experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_simpy/06_replications.html">Multiple replications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">streamlit sim apps</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/01_intro.html">What is streamlit?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/02_design.html">Main concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/03_experiment.html">The <code class="docutils literal notranslate"><span class="pre">Experiment</span></code> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/04_wrapper.html">Wrapper functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/05_module.html">Python module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/06_basic_app.html">A first web app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/07_interactive.html">An interactive app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/08_sidebar.html">Tidying up controls</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/09_adding_text.html">Background text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/10_adding_plots.html">Adding plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/11_filter_results.html">Filtering results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/12_multiple_experiments.html">Loading and running multiple experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_streamlit/13_ciw_backend.html">Replacing <code class="docutils literal notranslate"><span class="pre">simpy</span></code> with <code class="docutils literal notranslate"><span class="pre">ciw</span></code></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exercises</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../04_exercises/01_sampling.html">Random sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_exercises/02_generator.html">Generator exercise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_exercises/03_basic_results.html">Results collection exercise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_exercises/04_callback.html">Adding a patient callback from a nurse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_exercises/05_treat_sim.html"><code class="docutils literal notranslate"><span class="pre">simpy</span></code> treatment centre model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_exercises/06_streamlit.html">Treatment sim <code class="docutils literal notranslate"><span class="pre">streamlit</span></code> app</a></li>

<li class="toctree-l1"><a class="reference internal" href="../04_exercises/07_plotting.html">Adding a plot</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Solutions</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_sampling.html">Random sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_generator.html">Generator exercise</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Results collection exercise</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_callback.html">Adding a patient callback from a nurse</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_treat_sim.html"><code class="docutils literal notranslate"><span class="pre">simpy</span></code> treatment centre model</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_streamlit.html">Treatment sim <code class="docutils literal notranslate"><span class="pre">streamlit</span></code> app</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_plotting.html">Adding a plot</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/health-data-science-OR/natcor-simpy/main?urlpath=lab/tree/content/05_solutions/03_basic_results.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/health-data-science-OR/natcor-simpy/blob/main/content/05_solutions/03_basic_results.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/health-data-science-OR/natcor-simpy" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/health-data-science-OR/natcor-simpy/issues/new?title=Issue%20on%20page%20%2Fcontent/05_solutions/03_basic_results.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/05_solutions/03_basic_results.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Results collection exercise</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-calculating-the-utilisation-of-the-call-operators">Exercise: calculating the utilisation of the call operators.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">1. Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-logic">2. Model and Logic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-level-variables-for-results-collection">2.1 Notebook level variables for results collection.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-helper-function">2.2 A helper function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#service-and-arrival-functions">2.3 Service and arrival functions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="results-collection-exercise">
<h1>Results collection exercise<a class="headerlink" href="#results-collection-exercise" title="Permalink to this heading">#</a></h1>
<section id="exercise-calculating-the-utilisation-of-the-call-operators">
<h2>Exercise: calculating the utilisation of the call operators.<a class="headerlink" href="#exercise-calculating-the-utilisation-of-the-call-operators" title="Permalink to this heading">#</a></h2>
<p>The 111 caller model is replicated below.  At the moment this only collects results for the mean waiting time experienced by callers. Your task is to update the code so that the average utilsation of the call operators is calculated.</p>
<p><strong>Task:</strong></p>
<ol class="arabic simple">
<li><p>Create a new entry to the results dictionary with the key <code class="docutils literal notranslate"><span class="pre">total_call_duration</span></code></p>
<ul class="simple">
<li><p>You will use <code class="docutils literal notranslate"><span class="pre">results['total_call_duration']</span></code> to store the total time operators are in use during the model run.</p></li>
</ul>
</li>
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">service</span></code> function to update <code class="docutils literal notranslate"><span class="pre">total_call_duration</span></code> after each call completes.</p></li>
<li><p>After the run has completed calculate the average operator utilisation.</p></li>
<li><p>Print the results to the screen.</p></li>
</ol>
<p><strong>Hints:</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">service</span> </code> function could update the total_call_duration as follows (where <code class="docutils literal notranslate"><span class="pre">call_duration</span></code> is the length of time a caller has just spent with an operator).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_call_duration&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">call_duration</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Average operator utilisation is calculated by:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mean_util</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_call_duration&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">RUN_LENGTH</span> <span class="o">*</span> <span class="n">N_OPERATORS</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
</pre></div>
</div>
<blockquote>
<div><p>note we don’t quite capture all operator utilisation using this method.  When the simulation terminates there will be a number of callers in service.  This can be fixed using some additional logic, and its up to you to decide if this is an issue with results reporting.  For this exercise we will ignore it.</p>
</div></blockquote>
</section>
<section id="imports">
<h2>1. Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">simpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-and-logic">
<h2>2. Model and Logic<a class="headerlink" href="#model-and-logic" title="Permalink to this heading">#</a></h2>
<section id="notebook-level-variables-for-results-collection">
<h3>2.1 Notebook level variables for results collection.<a class="headerlink" href="#notebook-level-variables-for-results-collection" title="Permalink to this heading">#</a></h3>
<p>The list has notebook level scope. This means that any functions or class in the notebook can access and/or append to the list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">results</span><span class="p">[</span><span class="s1">&#39;waiting_times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ##############################################################################</span>
<span class="c1"># MODIFICATION: added in 2nd results variable</span>
<span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_call_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="c1">################################################################################</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-helper-function">
<h3>2.2 A helper function<a class="headerlink" href="#a-helper-function" title="Permalink to this heading">#</a></h3>
<p>We will create a helper function called trace that wraps <code class="docutils literal notranslate"><span class="pre">print</span></code>.  We can set a variable called <code class="docutils literal notranslate"><span class="pre">TRACE</span></code> that switches printing patient level results on and off.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Turing printing of events on and off.</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    -------</span>
<span class="sd">    msg: str</span>
<span class="sd">        string to print to screen.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">TRACE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="service-and-arrival-functions">
<h2>2.3 Service and arrival functions<a class="headerlink" href="#service-and-arrival-functions" title="Permalink to this heading">#</a></h2>
<p>You need to modify the <code class="docutils literal notranslate"><span class="pre">service</span></code> function.  Add a line of code to update <code class="docutils literal notranslate"><span class="pre">total_call_duration</span></code> following a completed call.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">service</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operators</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    simulates the service process for a call operator</span>

<span class="sd">    1. request and wait for a call operator</span>
<span class="sd">    2. phone triage (triangular)</span>
<span class="sd">    3. exit system</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    ------</span>
<span class="sd">    </span>
<span class="sd">    identifier: int </span>
<span class="sd">        A unique identifer for this caller</span>
<span class="sd">        </span>
<span class="sd">    operators: simpy.Resource</span>
<span class="sd">        The pool of call operators that answer calls</span>
<span class="sd">        These are shared across resources.</span>
<span class="sd">        </span>
<span class="sd">    env: simpy.Environment</span>
<span class="sd">        The current environent the simulation is running in</span>
<span class="sd">        We use this to pause and restart the process after a delay.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># record the time that call entered the queue</span>
    <span class="n">start_wait</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">now</span>

    <span class="c1"># request an operator</span>
    <span class="k">with</span> <span class="n">operators</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">req</span>

        <span class="c1"># record the waiting time for call to be answered</span>
        <span class="n">waiting_time</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_wait</span>
        
        <span class="c1"># store the waiting time.</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;waiting_times&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waiting_time</span><span class="p">)</span>

        <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;operator answered call </span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> at &#39;</span> \
              <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># sample call duration.</span>
        <span class="n">call_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">triangular</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
                                             <span class="n">right</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        
        <span class="c1"># schedule process to begin again after call_duration</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">call_duration</span><span class="p">)</span>
        
        <span class="c1"># ######################################################################</span>
        <span class="c1"># MODIFICATION: update total call duration in results</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_call_duration&#39;</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">call_duration</span>
        <span class="c1">########################################################################</span>

        <span class="c1"># print out information for patient.</span>
        <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;call </span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> ended </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">; &#39;</span> \
              <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="n">waiting_time</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">arrivals_generator</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">operators</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    IAT is exponentially distributed</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------</span>
<span class="sd">    env: simpy.Environment</span>
<span class="sd">        The simpy environment for the simulation</span>

<span class="sd">    operators: simpy.Resource</span>
<span class="sd">        the pool of call operators.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># use itertools as it provides an infinite loop </span>
    <span class="c1"># with a counter variable that we can use for unique Ids</span>
    <span class="k">for</span> <span class="n">caller_count</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="c1"># 100 calls per hour (units = hours). </span>
        <span class="c1"># Time between calls is 1/100</span>
        <span class="n">inter_arrival_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">60</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">inter_arrival_time</span><span class="p">)</span>

        <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;call arrives at: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># create a new simpy process for this caller.</span>
        <span class="c1"># we pass in the caller id, the operator resources, and env.</span>
        <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">service</span><span class="p">(</span><span class="n">caller_count</span><span class="p">,</span> <span class="n">operators</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model parameters</span>
<span class="n">RUN_LENGTH</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">N_OPERATORS</span> <span class="o">=</span> <span class="mi">13</span>

<span class="c1"># MODIFICATION - turn off caller level results.</span>
<span class="n">TRACE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># create simpy environment and operator resources</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="n">operators</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="n">N_OPERATORS</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arrivals_generator</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">operators</span><span class="p">))</span>
<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">RUN_LENGTH</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;end of run. simulation clock time = </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># calculate results on notebook level variables.</span>
<span class="n">mean_wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;waiting_times&#39;</span><span class="p">])</span>

<span class="c1"># ##############################################################################</span>
<span class="c1"># MODIFICATION:  calculate mean operator utilisation</span>
<span class="n">mean_util</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_call_duration&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">RUN_LENGTH</span> <span class="o">*</span> <span class="n">N_OPERATORS</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
<span class="c1"># ##############################################################################</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean waiting time was </span><span class="si">{</span><span class="n">mean_wt</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># ##############################################################################</span>
<span class="c1"># MODIFICATION: print out results</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean operator utilisation </span><span class="si">{</span><span class="n">mean_util</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="c1"># ##############################################################################</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>end of run. simulation clock time = 1000
Mean waiting time was 1.53
Mean operator utilisation 91.96%
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "health-data-science-OR/natcor-simpy",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/05_solutions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="02_generator.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Generator exercise</p>
      </div>
    </a>
    <a class="right-next"
       href="04_callback.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Adding a patient callback from a nurse</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-calculating-the-utilisation-of-the-call-operators">Exercise: calculating the utilisation of the call operators.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">1. Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-logic">2. Model and Logic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-level-variables-for-results-collection">2.1 Notebook level variables for results collection.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-helper-function">2.2 A helper function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#service-and-arrival-functions">2.3 Service and arrival functions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Thomas Monks
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>